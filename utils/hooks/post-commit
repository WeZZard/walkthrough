#!/bin/bash
# Post-commit hook for generating comprehensive coverage reports
# Runs in background to avoid blocking the commit workflow

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

REPO_ROOT="$(git rev-parse --show-toplevel)"
UTILS_DIR="${REPO_ROOT}/utils"
COVERAGE_DIR="${REPO_ROOT}/target/coverage"
REPORTS_DIR="${REPO_ROOT}/target/coverage_report"

mkdir -p "${REPORTS_DIR}"
mkdir -p "${COVERAGE_DIR}"

echo -e "${BLUE}[POST-COMMIT]${NC} Generating coverage reports in background..."

# Function to generate reports
generate_reports() {
    # Create timestamp for this report
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    COMMIT_SHA=$(git rev-parse --short HEAD)
    REPORT_NAME="coverage_${COMMIT_SHA}_${TIMESTAMP}"
    LOG_FILE="${REPORTS_DIR}/${REPORT_NAME}.log"
    
    # Run coverage collection and report generation
    echo "Running coverage collection..." >> "${LOG_FILE}"
    
    # First collect coverage data
    if cargo run --release --manifest-path "${REPO_ROOT}/utils/coverage_helper/Cargo.toml" -- collect >> "${LOG_FILE}" 2>&1; then
        echo "Coverage collection successful" >> "${LOG_FILE}"
        
        # Then generate HTML report
        echo "Generating HTML report..." >> "${LOG_FILE}"
        cargo run --release --manifest-path "${REPO_ROOT}/utils/coverage_helper/Cargo.toml" -- report --format html >> "${LOG_FILE}" 2>&1
    else
        echo "Coverage collection failed" >> "${LOG_FILE}"
    fi
    
    # Create coverage trend file if it doesn't exist
    TREND_FILE="${COVERAGE_DIR}/coverage_trend.csv"
    if [[ ! -f "$TREND_FILE" ]]; then
        echo "timestamp,commit,total_coverage,integration_score" > "$TREND_FILE"
    fi
    
    # Extract coverage percentages from merged LCOV
    if [[ -f "${REPORTS_DIR}/merged.lcov" ]]; then
        TOTAL_COV=$(lcov --summary "${REPORTS_DIR}/merged.lcov" 2>&1 | grep lines | awk '{print $2}' | sed 's/%//' || echo "0")
    else
        TOTAL_COV="0"
    fi
    
    # Extract integration score from log
    INTEGRATION_SCORE=$(grep "INTEGRATION SCORE:" "${COVERAGE_DIR}/${REPORT_NAME}.log" | grep -oE '[0-9]+/100' | cut -d'/' -f1 || echo "0")
    
    # Append to trend file
    echo "${TIMESTAMP},${COMMIT_SHA},${TOTAL_COV},${INTEGRATION_SCORE}" >> "$TREND_FILE"
    
    # Generate trend analysis
    generate_trend_analysis
    
    # Open HTML report if in interactive mode and on macOS
    if [[ -t 1 ]] && [[ "$(uname)" == "Darwin" ]]; then
        if [[ -f "${REPORTS_DIR}/index.html" ]]; then
            echo -e "${BLUE}[POST-COMMIT]${NC} Opening coverage report in browser..."
            open "${REPORTS_DIR}/index.html" 2>/dev/null || true
        fi
    fi
    
    echo -e "${GREEN}[POST-COMMIT]${NC} Coverage report generated: ${REPORTS_DIR}/index.html"
    echo -e "${GREEN}[POST-COMMIT]${NC} Coverage trend updated: ${TREND_FILE}"
}

# Function to generate trend analysis
generate_trend_analysis() {
    local TREND_REPORT="${REPORTS_DIR}/trend_analysis.txt"

    touch "$TREND_REPORT"
    
    cat > "$TREND_REPORT" << EOF
=================================================================
           COVERAGE TREND ANALYSIS
=================================================================
Generated: $(date)
Latest Commit: $(git rev-parse --short HEAD)
Commit Message: $(git log -1 --pretty=%B | head -1)

COVERAGE HISTORY (Last 5 commits):
-----------------------------------
EOF
    
    # Show last 5 entries from trend file
    if [[ -f "${COVERAGE_DIR}/coverage_trend.csv" ]]; then
        echo "" >> "$TREND_REPORT"
        tail -5 "${COVERAGE_DIR}/coverage_trend.csv" | column -t -s',' >> "$TREND_REPORT"
    fi
    
    # Calculate coverage delta
    if [[ -f "${COVERAGE_DIR}/coverage_trend.csv" ]] && [[ $(wc -l < "${COVERAGE_DIR}/coverage_trend.csv") -gt 2 ]]; then
        PREV_LINE=$(tail -2 "${COVERAGE_DIR}/coverage_trend.csv" | head -1)
        CURR_LINE=$(tail -1 "${COVERAGE_DIR}/coverage_trend.csv")
        
        PREV_COV=$(echo "$PREV_LINE" | cut -d',' -f3)
        CURR_COV=$(echo "$CURR_LINE" | cut -d',' -f3)
        
        cat >> "$TREND_REPORT" << EOF

COVERAGE DELTA:
---------------
EOF
        
        # Calculate and show delta
        if command -v bc &>/dev/null; then
            COV_DELTA=$(echo "$CURR_COV - $PREV_COV" | bc 2>/dev/null || echo "0")
            
            if (( $(echo "$COV_DELTA > 0" | bc -l) )); then
                echo "Total Coverage: ↑ +${COV_DELTA}% (improved)" >> "$TREND_REPORT"
            elif (( $(echo "$COV_DELTA < 0" | bc -l) )); then
                echo "Total Coverage: ↓ ${COV_DELTA}% (decreased)" >> "$TREND_REPORT"
            else
                echo "Total Coverage: → 0% (unchanged)" >> "$TREND_REPORT"
            fi
        fi
    fi
    
    cat >> "$TREND_REPORT" << EOF

RECOMMENDATIONS:
----------------
EOF
    
    # Provide recommendations based on coverage
    if [[ -n "$TOTAL_COV" ]]; then
        if (( $(echo "$TOTAL_COV < 30" | bc -l 2>/dev/null || echo 1) )); then
            echo "⚠ Total coverage is below 30%. Consider adding more unit tests." >> "$TREND_REPORT"
        elif (( $(echo "$TOTAL_COV < 60" | bc -l 2>/dev/null || echo 0) )); then
            echo "→ Total coverage is moderate. Target 100% for changed lines per CLAUDE.md." >> "$TREND_REPORT"
        else
            echo "✓ Total coverage is good. Maintain 100% coverage on changed lines." >> "$TREND_REPORT"
        fi
    fi
    
    echo "" >> "$TREND_REPORT"
    echo "Full reports available at: ${REPORTS_DIR}" >> "$TREND_REPORT"
    echo "==================================================================" >> "$TREND_REPORT"
}

# Run report generation in background
{
    generate_reports
} &

# Store background job PID
BG_PID=$!
echo -e "${BLUE}[POST-COMMIT]${NC} Coverage report generation started (PID: $BG_PID)"
echo -e "${BLUE}[POST-COMMIT]${NC} Reports will be available at: ${REPORTS_DIR}"

# Git LFS hook
command -v git-lfs >/dev/null 2>&1 || { printf >&2 "\n%s\n\n" "This repository is configured for Git LFS but 'git-lfs' was not found on your path. If you no longer wish to use Git LFS, remove this hook by deleting the 'post-commit' file in the hooks directory (set by 'core.hookspath'; usually '.git/hooks')."; exit 2; }
git lfs post-commit "$@"

# Don't wait for background job - let commit complete immediately
exit 0
